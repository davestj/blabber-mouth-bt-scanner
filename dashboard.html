<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTHL Scanner - Tactical Operations Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="styles/base.css">
    <link rel="stylesheet" href="styles/dashboard.css">
</head>
<body>
    <!-- Top Command Bar -->
    <div class="top-bar">
        <div class="agency-header">
            <div class="agency-logo">
                <i class="fas fa-satellite-dish"></i>
            </div>

    <!-- Device Details Modal -->
    <div class="device-modal" id="deviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">DEVICE INTELLIGENCE REPORT</div>
                <button class="modal-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="device-info-grid" id="modalDeviceInfo">
                    <!-- Device info will be populated here -->
                </div>
                <div class="signal-graph">
                    <canvas class="waveform-canvas" id="modalWaveform"></canvas>
                </div>
            </div>
            <div class="modal-actions">
                <button class="control-btn" onclick="addToMonitoring()">
                    <i class="fas fa-eye"></i> ADD TO MONITORING
                </button>
                <button class="control-btn danger" onclick="flagModalDevice()">
                    <i class="fas fa-flag"></i> FLAG AS THREAT
                </button>
                <button class="control-btn" onclick="exportDeviceData()">
                    <i class="fas fa-download"></i> EXPORT DATA
                </button>
            </div>
        </div>
    </div>

    <!-- Monitoring Tab -->
    <button class="tab-toggle" onclick="toggleMonitoringTab()">MONITORING</button>
    <div class="monitoring-tab" id="monitoringTab">
        <div class="monitoring-header">
            <div class="panel-title">
                <i class="fas fa-eye"></i>
                MONITORED DEVICES
            </div>
        </div>
        <div class="monitoring-list" id="monitoringList">
            <!-- Monitored devices will appear here -->
        </div>
    </div>
            <div class="agency-title">BTHL TACTICAL OPERATIONS</div>
        </div>
        <div class="status-indicators">
            <div class="indicator active">
                <i class="fas fa-circle"></i>
                <span>System Online</span>
            </div>
            <div class="indicator" id="scanStatus">
                <i class="fas fa-radar"></i>
                <span>Scanner Idle</span>
            </div>
            <div class="indicator">
                <i class="fas fa-shield-alt"></i>
                <span>Security: MAX</span>
            </div>
            <div class="indicator">
                <i class="fas fa-user"></i>
                <span>Operator: ALPHA-7</span>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Radar Scanner Panel -->
        <div class="radar-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-radar"></i>
                    BLUETOOTH TACTICAL SCANNER
                </div>
                <div class="distance-indicator">
                    Range: <span class="distance-value">100m</span>
                </div>
            </div>
            <div class="radar-container">
                <svg class="radar-svg" viewBox="0 0 400 400">
                    <!-- Radar Grid -->
                    <defs>
                        <radialGradient id="radarGradient">
                            <stop offset="0%" style="stop-color:#00ff00;stop-opacity:0.3" />
                            <stop offset="100%" style="stop-color:#00ff00;stop-opacity:0" />
                        </radialGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    
                    <!-- Background circles -->
                    <circle cx="200" cy="200" r="180" fill="none" stroke="#0099cc" stroke-width="0.5" opacity="0.3"/>
                    <circle cx="200" cy="200" r="135" fill="none" stroke="#0099cc" stroke-width="0.5" opacity="0.3"/>
                    <circle cx="200" cy="200" r="90" fill="none" stroke="#0099cc" stroke-width="0.5" opacity="0.3"/>
                    <circle cx="200" cy="200" r="45" fill="none" stroke="#0099cc" stroke-width="0.5" opacity="0.3"/>
                    
                    <!-- Cross lines -->
                    <line x1="200" y1="20" x2="200" y2="380" stroke="#0099cc" stroke-width="0.5" opacity="0.3"/>
                    <line x1="20" y1="200" x2="380" y2="200" stroke="#0099cc" stroke-width="0.5" opacity="0.3"/>
                    
                    <!-- Sweep line -->
                    <line id="sweepLine" x1="200" y1="200" x2="200" y2="20" stroke="#00ff00" stroke-width="2" opacity="0.8" filter="url(#glow)">
                        <animateTransform
                            attributeName="transform"
                            attributeType="XML"
                            type="rotate"
                            from="0 200 200"
                            to="360 200 200"
                            dur="3s"
                            repeatCount="indefinite"/>
                    </line>
                    
                    <!-- Sweep fade effect -->
                    <path d="M 200,200 L 200,20 A 180,180 0 0,1 320,80 z" fill="url(#radarGradient)" opacity="0.5">
                        <animateTransform
                            attributeName="transform"
                            attributeType="XML"
                            type="rotate"
                            from="0 200 200"
                            to="360 200 200"
                            dur="3s"
                            repeatCount="indefinite"/>
                    </path>
                    
                    <!-- Device blips will be added here dynamically -->
                    <g id="deviceBlips"></g>
                    
                    <!-- Center point -->
                    <circle cx="200" cy="200" r="3" fill="#00ff00" filter="url(#glow)"/>
                </svg>
            </div>
            <div class="control-panel">
                <button class="control-btn" id="scanBtn">
                    <i class="fas fa-satellite-dish"></i> START SCAN
                </button>
                <button class="control-btn danger" id="flagBtn">
                    <i class="fas fa-flag"></i> FLAG DEVICE
                </button>
                <button class="control-btn" id="exportBtn">
                    <i class="fas fa-download"></i> EXPORT DATA
                </button>
            </div>
        </div>

        <!-- Device List Panel -->
        <div class="device-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-network-wired"></i>
                    DETECTED ENTITIES
                </div>
                <div class="distance-indicator">
                    <span id="deviceCount">0</span> Devices
                </div>
            </div>
            <div class="device-list" id="deviceList">
                <!-- Devices will be added dynamically -->
            </div>
        </div>

        <!-- Analysis Panel -->
        <div class="analysis-panel">
            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-chart-line"></i>
                    THREAT ANALYSIS
                </div>
            </div>
            
            <div class="threat-matrix">
                <div class="threat-level" id="threatLevel">
                    <span>THREAT LEVEL</span>
                    <span style="color: var(--success-green); font-weight: bold;">LOW</span>
                </div>
                <div class="threat-meter">
                    <div class="threat-fill" id="threatFill"></div>
                </div>
            </div>

            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-wave-square"></i>
                    SIGNAL ANALYSIS
                </div>
            </div>
            
            <div class="signal-graph">
                <canvas class="waveform-canvas" id="waveform"></canvas>
            </div>

            <div class="panel-header">
                <div class="panel-title">
                    <i class="fas fa-fingerprint"></i>
                    DEVICE PROFILE
                </div>
            </div>
            
            <div style="padding: 15px;" id="deviceProfile">
                <div style="color: var(--tactical-blue); font-size: 11px; text-align: center;">
                    SELECT A DEVICE FOR ANALYSIS
                </div>
            </div>
        </div>
    </div>

    <script>
        /*
         * File: dashboard.js
         * Author: David St John
         * Date: 2025-08-10
         * Purpose: Handle Bluetooth scanning and visualization for BTHL
         * We will integrate this with new Bluetooth library and Electron IPC
         */

        // Simulated device data for demonstration
        let devices = [];
        let scanning = false;
        let selectedDevice = null;
        let monitoredDevices = new Set();
        
        // Show device modal with live polling
        function showDeviceModal(device) {
            selectedDevice = device;
            const modal = document.getElementById('deviceModal');
            const infoGrid = document.getElementById('modalDeviceInfo');
            
            // Calculate threat assessment
            const threatLevel = calculateDeviceThreat(device);
            const threatColor = threatLevel === 'HIGH' ? 'var(--warning-red)' : 
                               threatLevel === 'MEDIUM' ? 'var(--alert-orange)' : 'var(--success-green)';
            
            // Triangulated position
            const position = device.rssiHistory?.length >= 3 ? 
                           triangulatePosition(device.rssiHistory.slice(-3)) : 
                           { x: '0', y: calculateDistance(device.rssi) };
            
            // Populate with live data attributes for updating
            infoGrid.innerHTML = `
                <div class="info-block">
                    <div class="info-label">Hardware Address</div>
                    <div class="info-value">${device.address}</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Device Name</div>
                    <div class="info-value">${device.name || 'Unknown'}</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Signal Strength</div>
                    <div class="info-value" data-signal="true">${device.rssi} dBm</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Distance</div>
                    <div class="info-value" data-distance="true">${calculateDistance(device.rssi)} meters</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Triangulated Position</div>
                    <div class="info-value" data-location="true">X: ${position.x}m, Y: ${position.y}m</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Signal Variance</div>
                    <div class="info-value">${device.rssiVariance || 0} dBm</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Device Type</div>
                    <div class="info-value"><i class="fas ${getDeviceIcon(device.type)}"></i> ${device.type || 'Unknown'}</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Bluetooth Version</div>
                    <div class="info-value">${device.connectable ? 'Classic (2.x/3.x)' : 'Low Energy (4.x/5.x)'}</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Auth Type</div>
                    <div class="info-value">${device.connectable ? 'PIN/Passkey' : 'Just Works'}</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Pairable</div>
                    <div class="info-value">${device.connectable ? 'Yes' : 'Limited'}</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Services</div>
                    <div class="info-value" style="font-size: 10px;">${device.services?.join(', ') || 'None advertised'}</div>
                </div>
                <div class="info-block">
                    <div class="info-label">Threat Assessment</div>
                    <div class="info-value" style="color: ${threatColor}; font-weight: bold;">
                        <i class="fas fa-shield-alt"></i> ${threatLevel}
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
            selectDevice(device);
        }
        
        function closeModal() {
            document.getElementById('deviceModal').classList.remove('active');
        }
        
        function addToMonitoring() {
            if (selectedDevice) {
                monitoredDevices.add(selectedDevice.address);
                updateMonitoringList();
                closeModal();
            }
        }
        
        function flagModalDevice() {
            if (selectedDevice) {
                document.getElementById('flagBtn').click();
                closeModal();
            }
        }
        
        function exportDeviceData() {
            if (selectedDevice) {
                const data = JSON.stringify(selectedDevice, null, 2);
                console.log('Device data:', data);
                // Could integrate with file save here
            }
        }
        
        function toggleMonitoringTab() {
            document.getElementById('monitoringTab').classList.toggle('active');
        }
        
        function updateMonitoringList() {
            const list = document.getElementById('monitoringList');
            list.innerHTML = '';
            
            devices.filter(d => monitoredDevices.has(d.address)).forEach(device => {
                const el = document.createElement('div');
                el.className = 'monitored-device';
                el.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: var(--electric-blue)">${device.name || 'Unknown'}</span>
                        <button onclick="removeFromMonitoring('${device.address}')" style="background: transparent; border: none; color: var(--warning-red); cursor: pointer;">×</button>
                    </div>
                    <div style="font-size: 10px;">
                        <div>MAC: ${device.address}</div>
                        <div>RSSI: ${device.rssi} dBm</div>
                        <div>Distance: ${calculateDistance(device.rssi)}m</div>
                        <div>Last Seen: ${new Date(device.lastSeen).toLocaleTimeString()}</div>
                    </div>
                `;
                list.appendChild(el);
            });
        }
        
        function removeFromMonitoring(address) {
            monitoredDevices.delete(address);
            updateMonitoringList();
        }

        // Initialize waveform canvas
        const canvas = document.getElementById('waveform');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;

        // Draw waveform
        function drawWaveform(strength = 0) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for (let x = 0; x < canvas.width; x++) {
                const y = canvas.height / 2 + Math.sin(x * 0.05 + Date.now() * 0.001) * (strength / 2);
                if (x === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            
            ctx.stroke();
        }

        // Animate waveform
        function animateWaveform() {
            drawWaveform(selectedDevice ? Math.abs(selectedDevice.rssi) : 20);
            requestAnimationFrame(animateWaveform);
        }
        animateWaveform();

        // Calculate distance with both metric and imperial
        function calculateDistance(rssi) {
            const txPower = -59;
            const n = 2;
            const meters = Math.pow(10, (txPower - rssi) / (10 * n));
            const feet = meters * 3.28084;
            const yards = meters * 1.09361;
            
            return {
                meters: meters.toFixed(1),
                feet: feet.toFixed(1),
                yards: yards.toFixed(1),
                display: `${meters.toFixed(1)}m / ${feet.toFixed(0)}ft`
            };
        }
        
        // Get display distance string
        function getDistanceDisplay(rssi) {
            const dist = calculateDistance(rssi);
            return dist.display;
        }

        // Add device to radar
        function addDeviceToRadar(device, index) {
            const blips = document.getElementById('deviceBlips');
            
            // Calculate position based on RSSI (stronger signal = closer to center)
            const distance = Math.min(180, Math.abs(device.rssi) * 2);
            const angle = (index * 60) % 360;
            const x = 200 + distance * Math.cos(angle * Math.PI / 180);
            const y = 200 + distance * Math.sin(angle * Math.PI / 180);
            
            const blip = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            blip.setAttribute('cx', x);
            blip.setAttribute('cy', y);
            blip.setAttribute('r', '5');
            blip.setAttribute('fill', device.flagged ? '#ff3333' : '#00ff00');
            blip.setAttribute('filter', 'url(#glow)');
            blip.setAttribute('data-device-id', device.address);
            
            // Add pulsing animation
            const animate = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
            animate.setAttribute('attributeName', 'r');
            animate.setAttribute('values', '5;8;5');
            animate.setAttribute('dur', '2s');
            animate.setAttribute('repeatCount', 'indefinite');
            blip.appendChild(animate);
            
            blips.appendChild(blip);
        }

        // Device type icons
        function getDeviceIcon(type) {
            const icons = {
                'Phone': 'fa-mobile-alt',
                'Audio': 'fa-headphones',
                'Wearable': 'fa-watch',
                'Media': 'fa-tv',
                'Computer': 'fa-laptop',
                'Vehicle': 'fa-car',
                'Suspicious': 'fa-exclamation-triangle',
                'Camera': 'fa-camera',
                'HID': 'fa-keyboard',
                'Unknown': 'fa-question-circle'
            };
            return icons[type] || 'fa-bluetooth';
        }
        
        // Add device to list with icon
        function addDeviceToList(device) {
            // Don't add duplicates
            const existingDevice = document.querySelector(`[data-device-address="${device.address}"]`);
            if (existingDevice) {
                updateDeviceElement(existingDevice, device);
                return;
            }
            
            const deviceEl = document.createElement('div');
            deviceEl.className = `device-item ${device.flagged ? 'flagged' : ''}`;
            deviceEl.setAttribute('data-device-address', device.address);
            
            // Calculate threat level
            const threatLevel = calculateDeviceThreat(device);
            const threatColor = threatLevel === 'HIGH' ? 'var(--warning-red)' : 
                               threatLevel === 'MEDIUM' ? 'var(--alert-orange)' : 'var(--success-green)';
            
            deviceEl.innerHTML = `
                <div class="device-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas ${getDeviceIcon(device.type)}" style="color: ${threatColor}"></i>
                        <div class="device-name">${device.name || 'Unknown Device'}</div>
                    </div>
                    <div class="device-status">
                        <div class="status-dot" style="background: ${threatColor}; animation: ${threatLevel === 'HIGH' ? 'pulse 1s infinite' : 'none'}"></div>
                    </div>
                </div>
                <div class="device-details">
                    <div class="detail-item">
                        <span class="detail-label">MAC:</span>
                        <span class="detail-value">${device.address}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">RSSI:</span>
                        <span class="detail-value">${device.rssi} dBm</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Distance:</span>
                        <span class="detail-value">${getDistanceDisplay(device.rssi)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Threat:</span>
                        <span class="detail-value" style="color: ${threatColor}">${threatLevel}</span>
                    </div>
                </div>
            `;
            
            deviceEl.onclick = () => showDeviceModal(device);
            document.getElementById('deviceList').appendChild(deviceEl);
        }
        
        // Calculate device threat level
        function calculateDeviceThreat(device) {
            let score = 0;
            
            // Check suspicious patterns
            const name = (device.name || '').toLowerCase();
            const suspicious = ['spy', 'cam', 'hidden', 'hc-', 'esp', 'mini'];
            if (suspicious.some(p => name.includes(p))) score += 40;
            
            // Unknown device with strong signal
            if (!device.name && device.rssi > -50) score += 30;
            
            // Device type suspicious
            if (device.type === 'Suspicious') score += 50;
            
            // No services advertised
            if (!device.services || device.services.length === 0) score += 20;
            
            return score >= 60 ? 'HIGH' : score >= 30 ? 'MEDIUM' : 'LOW';
        }
        
        function updateDeviceElement(element, device) {
            element.querySelector('.device-name').textContent = device.name || 'Unknown Device';
            element.querySelector('.detail-value:nth-of-type(2)').textContent = `${device.rssi} dBm`;
            element.querySelector('.detail-value:nth-of-type(3)').textContent = `${calculateDistance(device.rssi)}m`;
        }

        // Select device for analysis
        function selectDevice(device) {
            selectedDevice = device;
            
            // Update device profile
            const profile = document.getElementById('deviceProfile');
            profile.innerHTML = `
                <div style="background: var(--panel-dark); padding: 15px; border: 1px solid var(--tactical-blue);">
                    <div style="color: var(--electric-blue); font-size: 14px; margin-bottom: 10px;">${device.name || 'Unknown'}</div>
                    <div style="display: grid; gap: 8px; font-size: 11px;">
                        <div><span style="color: var(--tactical-blue);">Hardware Address:</span> <span style="color: var(--metal-silver);">${device.address}</span></div>
                        <div><span style="color: var(--tactical-blue);">Signal Strength:</span> <span style="color: var(--metal-silver);">${device.rssi} dBm</span></div>
                        <div><span style="color: var(--tactical-blue);">Estimated Range:</span> <span style="color: var(--metal-silver);">${calculateDistance(device.rssi)} meters</span></div>
                        <div><span style="color: var(--tactical-blue);">Device Class:</span> <span style="color: var(--metal-silver);">${device.type || 'Unknown'}</span></div>
                        <div><span style="color: var(--tactical-blue);">Threat Level:</span> <span style="color: ${device.flagged ? 'var(--warning-red)' : 'var(--success-green)'};">${device.flagged ? 'HIGH' : 'LOW'}</span></div>
                        <div><span style="color: var(--tactical-blue);">First Seen:</span> <span style="color: var(--metal-silver);">${new Date().toLocaleTimeString()}</span></div>
                    </div>
                </div>
            `;
            
            // Update threat level
            updateThreatLevel();
        }

        // Update threat level based on flagged devices
        function updateThreatLevel() {
            const flaggedCount = devices.filter(d => d.flagged).length;
            const threatLevel = document.getElementById('threatLevel');
            const threatFill = document.getElementById('threatFill');
            
            if (flaggedCount === 0) {
                threatLevel.className = 'threat-level';
                threatLevel.innerHTML = '<span>THREAT LEVEL</span><span style="color: var(--success-green); font-weight: bold;">LOW</span>';
                threatFill.style.width = '30%';
            } else if (flaggedCount < 3) {
                threatLevel.className = 'threat-level medium';
                threatLevel.innerHTML = '<span>THREAT LEVEL</span><span style="color: var(--alert-orange); font-weight: bold;">MEDIUM</span>';
                threatFill.style.width = '60%';
            } else {
                threatLevel.className = 'threat-level high';
                threatLevel.innerHTML = '<span>THREAT LEVEL</span><span style="color: var(--warning-red); font-weight: bold;">HIGH</span>';
                threatFill.style.width = '90%';
            }
        }

        // Real device polling with proper accumulation
        async function pollDevices() {
            if (!scanning) return;
            
            try {
                const scannedDevices = await window.bthlAPI.bluetooth.getDevices();
                
                // Process each device without clearing
                scannedDevices.forEach((device) => {
                    // Find or add device
                    let existingDevice = devices.find(d => d.address === device.address);
                    
                    if (existingDevice) {
                        // Update RSSI history for triangulation
                        if (!existingDevice.rssiHistory) existingDevice.rssiHistory = [];
                        existingDevice.rssiHistory.push(device.rssi);
                        if (existingDevice.rssiHistory.length > 10) existingDevice.rssiHistory.shift();
                        
                        // Calculate RSSI variance for movement detection
                        const variance = Math.max(...existingDevice.rssiHistory) - Math.min(...existingDevice.rssiHistory);
                        device.rssiVariance = variance;
                        
                        // Update device data
                        Object.assign(existingDevice, device);
                        updateDeviceElement(document.querySelector(`[data-device-address="${device.address}"]`), device);
                    } else {
                        // New device
                        device.rssiHistory = [device.rssi];
                        device.rssiVariance = 0;
                        devices.push(device);
                        addDeviceToList(device);
                        addDeviceToRadar(device, devices.length - 1);
                    }
                });
                
                // Update counts and threat analysis
                document.getElementById('deviceCount').textContent = devices.length;
                updateThreatLevel();
                
                // Update modal if open
                if (selectedDevice && document.getElementById('deviceModal').classList.contains('active')) {
                    const updated = devices.find(d => d.address === selectedDevice.address);
                    if (updated) {
                        updateModalData(updated);
                    }
                }
                
                // Update monitoring list
                updateMonitoringList();
                
            } catch (error) {
                console.error('Polling error:', error);
            }
            
            // Continue polling
            if (scanning) {
                setTimeout(pollDevices, 500); // Faster polling for live data
            }
        }
        
        // Update modal with live data
        function updateModalData(device) {
            const signalEl = document.querySelector('.info-value[data-signal]');
            const distanceEl = document.querySelector('.info-value[data-distance]');
            const locationEl = document.querySelector('.info-value[data-location]');
            
            if (signalEl) signalEl.textContent = `${device.rssi} dBm`;
            if (distanceEl) distanceEl.textContent = `${calculateDistance(device.rssi)} meters`;
            
            // Triangulate position if we have enough data
            if (device.rssiHistory && device.rssiHistory.length >= 3) {
                const position = triangulatePosition(device.rssiHistory.slice(-3));
                if (locationEl) locationEl.textContent = `X: ${position.x}m, Y: ${position.y}m`;
            }
        }
        
        // Triangulation calculation
        function triangulatePosition(rssiValues) {
            // Simple triangulation based on RSSI from multiple readings
            const distances = rssiValues.map(rssi => parseFloat(calculateDistance(rssi)));
            
            // Assuming readings from different angles
            const x = (distances[0] + distances[1]) / 2 * Math.cos(Math.PI / 4);
            const y = (distances[1] + distances[2]) / 2 * Math.sin(Math.PI / 4);
            
            return { x: x.toFixed(1), y: y.toFixed(1) };
        }

        // Scan button handler with real Bluetooth - DO NOT CLEAR DEVICES
        document.getElementById('scanBtn').addEventListener('click', async function() {
            scanning = !scanning;
            const scanStatus = document.getElementById('scanStatus');
            
            if (scanning) {
                try {
                    await window.bthlAPI.bluetooth.startScan();
                    
                    this.innerHTML = '<i class="fas fa-stop"></i> STOP SCAN';
                    this.classList.add('scanning');
                    scanStatus.classList.add('active');
                    scanStatus.innerHTML = '<i class="fas fa-radar"></i><span>Scanner Active</span>';
                    
                    // DO NOT clear devices - accumulate them
                    // devices = []; // REMOVED THIS LINE
                    // document.getElementById('deviceList').innerHTML = ''; // REMOVED THIS LINE
                    // document.getElementById('deviceBlips').innerHTML = ''; // REMOVED THIS LINE
                    
                    // Start polling for devices
                    pollDevices();
                } catch (error) {
                    console.error('Failed to start scan:', error);
                    scanning = false;
                }
            } else {
                try {
                    await window.bthlAPI.bluetooth.stopScan();
                    
                    this.innerHTML = '<i class="fas fa-satellite-dish"></i> START SCAN';
                    this.classList.remove('scanning');
                    scanStatus.classList.remove('active');
                    scanStatus.innerHTML = '<i class="fas fa-radar"></i><span>Scanner Idle</span>';
                } catch (error) {
                    console.error('Failed to stop scan:', error);
                }
            }
        });

        // Flag button handler with database integration
        document.getElementById('flagBtn').addEventListener('click', async function() {
            if (selectedDevice) {
                try {
                    const newFlagState = !selectedDevice.flagged;
                    const reason = newFlagState ? prompt('Reason for flagging:', 'Suspicious activity') : null;
                    
                    // Update in backend
                    await window.bthlAPI.bluetooth.flagDevice(selectedDevice.address, newFlagState, reason);
                    
                    selectedDevice.flagged = newFlagState;
                    
                    // Update UI
                    document.querySelectorAll('.device-item').forEach(el => {
                        const macText = el.querySelector('.detail-value').textContent;
                        if (macText === selectedDevice.address) {
                            el.classList.toggle('flagged');
                        }
                    });
                    
                    // Update radar blip
                    document.querySelectorAll('#deviceBlips circle').forEach(blip => {
                        if (blip.getAttribute('data-device-id') === selectedDevice.address) {
                            blip.setAttribute('fill', selectedDevice.flagged ? '#ff3333' : '#00ff00');
                        }
                    });
                    
                    selectDevice(selectedDevice); // Refresh profile
                } catch (error) {
                    console.error('Failed to flag device:', error);
                }
            }
        });

        // Export button handler with real export
        document.getElementById('exportBtn').addEventListener('click', async function() {
            try {
                const result = await window.bthlAPI.bluetooth.exportData();
                if (result.success) {
                    alert(`Data exported to: ${result.path}`);
                }
            } catch (error) {
                console.error('Export failed:', error);
                alert('Failed to export data');
            }
        });
        
        // Load initial statistics
        async function loadStatistics() {
            try {
                const stats = await window.bthlAPI.bluetooth.getStatistics();
                console.log('System statistics:', stats);
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }
        
        loadStatistics();
    </script>
</body>
</html>
